// SendIt Delivery Platform - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  phone         String    @unique
  email         String?   @unique
  name          String?
  avatar        String?
  walletBalance Decimal   @default(0) @db.Decimal(10, 2)
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  fcmToken      String?   // Firebase Cloud Messaging token
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  addresses           Address[]
  bookings            Booking[]
  reviews             Review[]
  notifications       Notification[]
  otps                OTP[]
  supportTickets      SupportTicket[]
  walletTransactions  WalletTransaction[]

  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Pilot {
  id              String      @id @default(cuid())
  phone           String      @unique
  email           String?     @unique
  name            String
  avatar          String?
  dateOfBirth     DateTime?
  gender          Gender?

  // Documents
  aadhaarNumber   String?     @unique
  licenseNumber   String?     @unique
  panNumber       String?     @unique

  // Status
  isVerified      Boolean     @default(false)
  isActive        Boolean     @default(true)
  isOnline        Boolean     @default(false)
  status          PilotStatus @default(PENDING)

  // Location
  currentLat      Float?
  currentLng      Float?
  lastLocationAt  DateTime?

  // Stats
  totalDeliveries Int         @default(0)
  rating          Float       @default(0)
  totalEarnings   Decimal     @default(0) @db.Decimal(10, 2)

  // Push Notifications
  fcmToken        String?     // Firebase Cloud Messaging token

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  vehicles        Vehicle[]
  bookings        Booking[]
  earnings        Earning[]
  reviews         Review[]
  documents       Document[]
  notifications   Notification[]
  otps            OTP[]
  bankAccounts    BankAccount[]
  supportTickets  SupportTicket[]

  @@index([status])
  @@index([isActive])
  @@index([isOnline])
  @@index([createdAt])
  @@map("pilots")
}

model Admin {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  role      AdminRole @default(ADMIN)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("admins")
}

// ============================================
// ADDRESS & LOCATION
// ============================================

model Address {
  id          String      @id @default(cuid())
  userId      String
  label       String      // Home, Office, etc.
  address     String
  landmark    String?
  city        String
  state       String
  pincode     String
  lat         Float
  lng         Float
  isDefault   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pickups     Booking[]   @relation("PickupAddress")
  drops       Booking[]   @relation("DropAddress")

  @@map("addresses")
}

// ============================================
// VEHICLE MODELS
// ============================================

model VehicleType {
  id              String    @id @default(cuid())
  name            String    @unique // Cycle, EV Cycle, 2 Wheeler, 3 Wheeler, Truck
  description     String?
  icon            String?
  maxWeight       Float     // in KG
  basePrice       Decimal   @db.Decimal(10, 2)
  pricePerKm      Decimal   @db.Decimal(10, 2)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  vehicles        Vehicle[]
  bookings        Booking[]

  @@map("vehicle_types")
}

model Vehicle {
  id              String      @id @default(cuid())
  pilotId         String
  vehicleTypeId   String
  registrationNo  String?     @unique
  model           String?
  color           String?
  isActive        Boolean     @default(true)
  isVerified      Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  pilot           Pilot       @relation(fields: [pilotId], references: [id], onDelete: Cascade)
  vehicleType     VehicleType @relation(fields: [vehicleTypeId], references: [id])
  bookings        Booking[]

  @@map("vehicles")
}

// ============================================
// BOOKING & DELIVERY
// ============================================

model Booking {
  id                String        @id @default(cuid())
  bookingNumber     String        @unique @default(cuid())
  userId            String
  pilotId           String?
  vehicleId         String?
  vehicleTypeId     String

  // Addresses
  pickupAddressId   String
  dropAddressId     String

  // Package Details
  packageType       PackageType   @default(PARCEL)
  packageWeight     Float?        // in KG
  packageDescription String?

  // Pricing
  distance          Float         // in KM
  baseFare          Decimal       @db.Decimal(10, 2)
  distanceFare      Decimal       @db.Decimal(10, 2)
  taxes             Decimal       @default(0) @db.Decimal(10, 2)
  discount          Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount       Decimal       @db.Decimal(10, 2)
  paymentMethod     PaymentMethod @default(CASH)
  paymentStatus     PaymentStatus @default(PENDING)

  // Status & Timing
  status            BookingStatus @default(PENDING)
  scheduledAt       DateTime?     // For scheduled deliveries
  acceptedAt        DateTime?
  pickedUpAt        DateTime?
  deliveredAt       DateTime?
  cancelledAt       DateTime?
  cancelReason      String?

  // OTP for delivery
  pickupOtp         String?
  deliveryOtp       String?

  // Tracking
  currentLat        Float?
  currentLng        Float?
  deliveryPhoto     String?       // Photo proof of delivery

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user              User          @relation(fields: [userId], references: [id])
  pilot             Pilot?        @relation(fields: [pilotId], references: [id])
  vehicle           Vehicle?      @relation(fields: [vehicleId], references: [id])
  vehicleType       VehicleType   @relation(fields: [vehicleTypeId], references: [id])
  pickupAddress     Address       @relation("PickupAddress", fields: [pickupAddressId], references: [id])
  dropAddress       Address       @relation("DropAddress", fields: [dropAddressId], references: [id])
  review            Review?
  payment           Payment?
  trackingHistory   TrackingHistory[]

  @@index([userId])
  @@index([pilotId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentStatus])
  @@map("bookings")
}

model TrackingHistory {
  id          String        @id @default(cuid())
  bookingId   String
  status      BookingStatus
  lat         Float?
  lng         Float?
  note        String?
  createdAt   DateTime      @default(now())

  // Relations
  booking     Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("tracking_history")
}

// ============================================
// PAYMENT & EARNINGS
// ============================================

model Payment {
  id              String        @id @default(cuid())
  bookingId       String        @unique
  amount          Decimal       @db.Decimal(10, 2)
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  transactionId   String?
  gatewayResponse Json?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  booking         Booking       @relation(fields: [bookingId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Earning {
  id          String      @id @default(cuid())
  pilotId     String
  bookingId   String?
  amount      Decimal     @db.Decimal(10, 2)
  type        EarningType @default(DELIVERY)
  description String?
  status      EarningStatus @default(PENDING)
  createdAt   DateTime    @default(now())

  // Relations
  pilot       Pilot       @relation(fields: [pilotId], references: [id])

  @@index([pilotId])
  @@index([status])
  @@index([createdAt])
  @@map("earnings")
}

model BankAccount {
  id            String    @id @default(cuid())
  pilotId       String    // Multiple accounts per pilot allowed
  accountName   String
  accountNumber String
  ifscCode      String
  bankName      String
  branchName    String?
  isPrimary     Boolean   @default(false)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  pilot         Pilot     @relation(fields: [pilotId], references: [id], onDelete: Cascade)

  @@map("bank_accounts")
}

// ============================================
// SUPPORT & FAQ
// ============================================

model SupportTicket {
  id          String    @id @default(cuid())
  pilotId     String?
  userId      String?
  subject     String
  description String
  category    String    @default("GENERAL")
  status      String    @default("OPEN")
  priority    String    @default("MEDIUM")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  resolvedAt  DateTime?

  // Relations
  pilot       Pilot?    @relation(fields: [pilotId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pilotId])
  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

model FAQ {
  id        String    @id @default(cuid())
  question  String
  answer    String
  category  String
  sortOrder Int       @default(0)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("faqs")
}

// ============================================
// WITHDRAWALS
// ============================================

model WithdrawalRequest {
  id            String    @id @default(cuid())
  pilotId       String
  bankAccountId String
  amount        Decimal   @db.Decimal(10, 2)
  status        String    @default("PENDING")
  adminNote     String?
  processedAt   DateTime?
  processedBy   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("withdrawal_requests")
}

// ============================================
// REFERRALS & ACHIEVEMENTS
// ============================================

model Referral {
  id            String    @id @default(cuid())
  referrerId    String
  referredId    String?
  referralCode  String    @unique
  status        String    @default("PENDING")
  bonusAmount   Decimal   @default(0) @db.Decimal(10, 2)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  @@map("referrals")
}

model Achievement {
  id          String    @id @default(cuid())
  name        String
  description String
  icon        String?
  requirement Json?
  rewardAmount Decimal  @default(0) @db.Decimal(10, 2)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@map("achievements")
}

model PilotAchievement {
  id            String    @id @default(cuid())
  pilotId       String
  achievementId String
  earnedAt      DateTime  @default(now())
  claimed       Boolean   @default(false)
  claimedAt     DateTime?

  @@unique([pilotId, achievementId])
  @@map("pilot_achievements")
}

// ============================================
// NOTIFICATION SETTINGS
// ============================================

model NotificationSetting {
  id              String    @id @default(cuid())
  pilotId         String    @unique
  pushEnabled     Boolean   @default(true)
  emailEnabled    Boolean   @default(false)
  smsEnabled      Boolean   @default(false)
  jobAlerts       Boolean   @default(true)
  promotions      Boolean   @default(true)
  updates         Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("notification_settings")
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id          String    @id @default(cuid())
  bookingId   String    @unique
  userId      String
  pilotId     String
  rating      Int       // 1-5
  comment     String?
  createdAt   DateTime  @default(now())

  // Relations
  booking     Booking   @relation(fields: [bookingId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
  pilot       Pilot     @relation(fields: [pilotId], references: [id])

  @@map("reviews")
}

// ============================================
// DOCUMENTS & VERIFICATION
// ============================================

model Document {
  id             String        @id @default(cuid())
  pilotId        String
  type           DocumentType
  url            String
  filename       String?
  status         DocumentStatus @default(PENDING)
  isVerified     Boolean       @default(false)
  rejectedReason String?
  verifiedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  pilot          Pilot         @relation(fields: [pilotId], references: [id], onDelete: Cascade)

  @@unique([pilotId, type])
  @@map("documents")
}

model OTP {
  id          String    @id @default(cuid())
  phone       String
  otp         String
  purpose     OTPPurpose
  userId      String?
  pilotId     String?
  expiresAt   DateTime
  isUsed      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  // Relations
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pilot       Pilot?    @relation(fields: [pilotId], references: [id], onDelete: Cascade)

  @@map("otps")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String    @id @default(cuid())
  userId      String?
  pilotId     String?
  title       String
  body        String
  type        NotificationType
  data        Json?
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  // Relations
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pilot       Pilot?    @relation(fields: [pilotId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// SETTINGS & CONFIG
// ============================================

model Setting {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("settings")
}

model ServiceArea {
  id          String    @id @default(cuid())
  name        String
  city        String
  state       String
  polygon     Json      // GeoJSON polygon
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("service_areas")
}

// ============================================
// COUPON & DISCOUNT SYSTEM
// ============================================

model Coupon {
  id              String        @id @default(cuid())
  code            String        @unique
  description     String?
  discountType    DiscountType  @default(PERCENTAGE)
  discountValue   Decimal       @db.Decimal(10, 2)
  minOrderAmount  Decimal?      @db.Decimal(10, 2)
  maxDiscount     Decimal?      @db.Decimal(10, 2)
  usageLimit      Int?          // Total uses allowed
  usageCount      Int           @default(0)
  perUserLimit    Int           @default(1) // Uses per user
  vehicleTypeIds  String[]      // Empty means all vehicle types
  isActive        Boolean       @default(true)
  startsAt        DateTime      @default(now())
  expiresAt       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  usages          CouponUsage[]

  @@map("coupons")
}

model CouponUsage {
  id        String    @id @default(cuid())
  couponId  String
  userId    String
  bookingId String?
  discount  Decimal   @db.Decimal(10, 2)
  usedAt    DateTime  @default(now())

  // Relations
  coupon    Coupon    @relation(fields: [couponId], references: [id])

  @@unique([couponId, bookingId])
  @@map("coupon_usages")
}

// ============================================
// WALLET & TRANSACTIONS
// ============================================

model WalletTransaction {
  id            String            @id @default(cuid())
  userId        String
  type          WalletTxnType
  amount        Decimal           @db.Decimal(10, 2)
  balanceBefore Decimal           @db.Decimal(10, 2)
  balanceAfter  Decimal           @db.Decimal(10, 2)
  description   String?
  referenceId   String?           // Booking ID, refund ID, etc.
  referenceType String?           // BOOKING, REFUND, TOPUP, etc.
  status        WalletTxnStatus   @default(COMPLETED)
  createdAt     DateTime          @default(now())

  // Relation
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("wallet_transactions")
}

// ============================================
// ENUMS
// ============================================

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PilotStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
}

enum PackageType {
  DOCUMENT
  PARCEL
  FOOD
  GROCERY
  MEDICINE
  FRAGILE
  OTHER
}

enum BookingStatus {
  PENDING
  ACCEPTED
  ARRIVED_PICKUP
  PICKED_UP
  IN_TRANSIT
  ARRIVED_DROP
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  WALLET
  NETBANKING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EarningType {
  DELIVERY
  BONUS
  INCENTIVE
  REFERRAL
  PENALTY
}

enum EarningStatus {
  PENDING
  PAID
  CANCELLED
}

enum DocumentType {
  AADHAAR_FRONT
  AADHAAR_BACK
  LICENSE_FRONT
  LICENSE_BACK
  PAN_CARD
  VEHICLE_RC
  VEHICLE_INSURANCE
  PROFILE_PHOTO
  VEHICLE_PHOTO
  ID_PROOF
  DRIVING_LICENSE
  INSURANCE
  POLLUTION_CERTIFICATE
  PARENTAL_CONSENT
  BANK_PROOF
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OTPPurpose {
  LOGIN
  SIGNUP
  RESET_PASSWORD
  VERIFY_PHONE
  PICKUP
  DELIVERY
}

enum NotificationType {
  BOOKING
  PAYMENT
  PROMOTION
  SYSTEM
  CHAT
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum WalletTxnType {
  CREDIT
  DEBIT
}

enum WalletTxnStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}
